<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Matrix Gym Protocol v7.0</title>
    <link rel="apple-touch-icon" href="https://img.icons8.com/ios-filled/150/00FF41/matrix-desktop.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --matrix-green: #00FF41; --dark-bg: #000; --card-bg: rgba(0, 15, 0, 0.95); --ss-red: #ff3131; }
        body { background-color: var(--dark-bg); color: var(--matrix-green); font-family: 'Courier New', Courier, monospace; margin: 0; overflow-x: hidden; }
        #matrix-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.15; }
        .container { padding: 15px; max-width: 600px; margin: auto; padding-bottom: 100px; }
        h1, h2 { text-transform: uppercase; text-align: center; border-bottom: 2px solid var(--matrix-green); padding-bottom: 10px; text-shadow: 0 0 10px var(--matrix-green); font-size: 1.2rem; }
        .card { background: var(--card-bg); border: 1px solid var(--matrix-green); border-radius: 8px; padding: 15px; margin-bottom: 20px; position: relative; }
        .ss-card { border: 2px solid var(--ss-red); box-shadow: 0 0 15px rgba(255, 49, 49, 0.4); }
        .sets-counter { position: absolute; top: 10px; right: 10px; font-size: 1.5rem; font-weight: bold; border: 1px solid var(--matrix-green); padding: 5px; background: rgba(0,255,65,0.1); }
        .btn { background: transparent; color: var(--matrix-green); border: 1px solid var(--matrix-green); width: 100%; padding: 15px; font-weight: bold; cursor: pointer; text-transform: uppercase; margin-bottom: 10px; font-size: 0.9rem; }
        .btn:active { background: var(--matrix-green); color: black; }
        .timer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .timer-display { font-size: 5rem; text-shadow: 0 0 20px var(--matrix-green); }
        .alarm-active { animation: flash red 0.3s infinite; }
        @keyframes flash { 50% { background-color: #900; } }
        .hidden { display: none; }
        input { background: #111; border: 1px solid var(--matrix-green); color: var(--matrix-green); width: 130px; text-align: center; font-size: 1.1rem; padding: 8px; margin-top: 5px; border-radius: 4px; }
    </style>
</head>
<body>
<canvas id="matrix-bg"></canvas>

<div id="unlock-screen" class="timer-overlay">
    <h2>> MATRIX_V7_ULTIMATE</h2>
    <p style="padding: 20px;">MEMORIA SINCRONIZZATA.<br>I carichi si salvano mentre scrivi.</p>
    <button class="btn" style="width: 80%; font-size: 1.5rem;" onclick="initAudio()">CARICA PROTOCOLLO</button>
</div>

<div class="container hidden" id="home">
    <h1>> DASHBOARD_OPERATIVA</h1>
    <div class="card"><canvas id="progressChart" height="180"></canvas></div>
    <button class="btn" onclick="openDay(1)">GIORNO_1 (GAMBE/SPALLE)</button>
    <button class="btn" onclick="openDay(2)">GIORNO_2 (DORSO/PETTO)</button>
    <button class="btn" onclick="openDay(3)">GIORNO_3 (MIX/GAMBE)</button>
    <button class="btn" style="color: #666; border-color: #444; font-size: 0.6rem; margin-top: 20px;" onclick="clearStorage()">[ RESET TOTALE MEMORIA ]</button>
</div>

<div class="container hidden" id="workout-view">
    <button class="btn" style="border:none; color:#666; font-size:0.7rem;" onclick="location.reload()">[ ESCI ]</button>
    <h2 id="current-day-title"></h2>
    <div id="exercise-list"></div>
</div>

<div id="timer-overlay" class="timer-overlay hidden">
    <div id="timer-label" style="font-size: 1.5rem;">RECUPERO_ATTIVO</div>
    <div class="timer-display" id="timer-text">00:00</div>
    <button id="stop-btn" class="btn hidden" style="border-color: var(--ss-red); color: var(--ss-red); font-size: 1.8rem; width: 80%;" onclick="stopAlarm()">STOP SIRENA</button>
</div>

<script>
let audioCtx, mainGain, alarmInterval, activeInterval;
let currentSets = {};

const workoutData = {
    1: [
        { name: "10 MINUTI ELLITTICA", total: 1, rest: 0, default: "1.6 km" },
        { name: "SS: AFFONDI + LEG CURL SEDUTO", total: 4, rest: 120, ss: true, default: "40kg/45kg" },
        { name: "LEG CURL", total: 4, rest: 90, ss: false, default: "30kg" },
        { name: "SHOULDER PRESS", total: 4, rest: 120, ss: false, default: "30kg" },
        { name: "ALZATE LATERALI SEDUTO", total: 4, rest: 120, ss: false, default: "5kg" },
        { name: "ALZATE FRONTALI ALTERNATE", total: 3, rest: 90, ss: false, default: "6kg" },
        { name: "CALF SU STEP (UN ARTO)", total: 8, rest: 45, ss: false, default: "20kg" },
        { name: "20 MIN TAPPETO PENDENZA", total: 1, rest: 0, default: "11,5% 4.5kmh" }
    ],
    2: [
        { name: "10 MINUTI ELLITTICA", total: 1, rest: 0, default: "1.6 km" },
        { name: "LAT MACHINE PRONA", total: 4, rest: 90, ss: false, default: "40kg" },
        { name: "PULLEY BASSO TRIANGOLO", total: 4, rest: 120, ss: false, default: "30kg" },
        { name: "LAT MACHINE STRETTA", total: 4, rest: 120, ss: false, default: "45kg" },
        { name: "PANCA INCLINATA", total: 5, rest: 90, ss: false, default: "12.5kg+bil" },
        { name: "APERTURE PANCA PIANA", total: 5, rest: 90, ss: false, default: "5kg" },
        { name: "10 MIN TAPPETO PENDENZA", total: 1, rest: 0, default: "11,5% 4.5kmh" }
    ],
    3: [
        { name: "10 MINUTI ELLITTICA", total: 1, rest: 0, default: "1.6 km" },
        { name: "STEP UP SU BOX", total: 4, rest: 90, ss: false, default: "40kg" },
        { name: "LEG EXTENSION", total: 5, rest: 120, ss: false, default: "45kg" },
        { name: "LEG CURL IN PIEDI", total: 4, rest: 90, ss: false, default: "30kg" },
        { name: "SS: ALZATE FRONT + SHOULDER", total: 4, rest: 120, ss: true, default: "12.5/25kg" },
        { name: "ALZATE LATERALI IN PIEDI", total: 5, rest: 90, ss: false, default: "6kg" },
        { name: "CALF SU STEP (UN ARTO)", total: 8, rest: 45, ss: false, default: "20kg" }
    ]
};

function initAudio() {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    mainGain = audioCtx.createGain();
    mainGain.connect(audioCtx.destination);
    document.getElementById('unlock-screen').classList.add('hidden');
    document.getElementById('home').classList.remove('hidden');
    initChart();
}

// SALVATAGGIO IMMEDIATO AD OGNI TASTO PREMUTO
function saveWeight(id, value) {
    localStorage.setItem('matrix_weight_' + id, value);
    console.log("Salvato: " + id + " = " + value);
}

function getWeight(id, defaultValue) {
    return localStorage.getItem('matrix_weight_' + id) || defaultValue;
}

function clearStorage() {
    if(confirm("Vuoi resettare tutti i pesi salvati?")) {
        localStorage.clear();
        location.reload();
    }
}

function openDay(day) {
    document.getElementById('home').classList.add('hidden');
    document.getElementById('workout-view').classList.remove('hidden');
    document.getElementById('current-day-title').innerText = "GIORNO_" + day;
    let html = "";
    workoutData[day].forEach((ex, idx) => {
        const id = `d${day}_e${idx}`;
        currentSets[id] = 0;
        const savedWeight = getWeight(id, ex.default);
        html += `<div class="card ${ex.ss ? 'ss-card' : ''}">
                <div class="sets-counter" id="cnt-${id}">0/${ex.total}</div>
                <strong>${ex.name}</strong><br><br>
                <span>KG: <input type="text" id="input-${id}" value="${savedWeight}" oninput="saveWeight('${id}', this.value)"></span><br>
                ${ex.rest > 0 ? `<button class="btn" style="margin-top:10px;" onclick="handleNextSet('${id}', ${ex.total}, ${ex.rest})">SERIE + RECUPERO</button>` : `<button class="btn" style="margin-top:10px;" onclick="handleNextSet('${id}', ${ex.total}, 0)">FATTO</button>`}
            </div>`;
    });
    document.getElementById('exercise-list').innerHTML = html;
}

function handleNextSet(id, total, rest) {
    if (currentSets[id] < total) {
        currentSets[id]++;
        document.getElementById(`cnt-${id}`).innerText = `${currentSets[id]}/${total}`;
    }
    if(rest > 0) startTimer(rest);
}

function startTimer(sec) {
    clearInterval(activeInterval);
    document.getElementById('timer-overlay').classList.remove('hidden');
    document.getElementById('stop-btn').classList.add('hidden');
    document.getElementById('timer-label').innerText = "RECUPERO_IN_CORSO";
    let timeLeft = sec;
    activeInterval = setInterval(() => {
        let m = Math.floor(timeLeft / 60);
        let s = timeLeft % 60;
        document.getElementById('timer-text').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        if (timeLeft <= 0) { clearInterval(activeInterval); triggerAlarm(); }
        timeLeft--;
    }, 1000);
}

function triggerAlarm() {
    document.getElementById('timer-label').innerText = "ðŸš¨ MUOVITI! ðŸš¨";
    document.getElementById('timer-overlay').classList.add('alarm-active');
    document.getElementById('stop-btn').classList.remove('hidden');
    alarmInterval = setInterval(() => {
        let osc = audioCtx.createOscillator();
        let g = audioCtx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(800 + Math.random() * 400, audioCtx.currentTime);
        osc.connect(g); g.connect(mainGain);
        g.gain.setValueAtTime(0.5, audioCtx.currentTime);
        osc.start(); osc.stop(audioCtx.currentTime + 0.3);
        if(navigator.vibrate) navigator.vibrate(500);
    }, 400);
}

function stopAlarm() {
    clearInterval(alarmInterval);
    document.getElementById('timer-overlay').classList.add('hidden');
    document.getElementById('timer-overlay').classList.remove('alarm-active');
}

function initChart() {
    const ctx = document.getElementById('progressChart').getContext('2d');
    new Chart(ctx, { type: 'line', data: { labels: ['Sett 1', 'Oggi'], datasets: [{ label: 'Carico Totale', data: [100, 150], borderColor: '#00FF41', tension: 0.3 }] }, options: { plugins: { legend: { display:false } }, scales: { x: { ticks: { color: '#00FF41' } }, y: { ticks: { color: '#00FF41' } } } } });
}

const canvas = document.getElementById('matrix-bg');
const ctxM = canvas.getContext('2d');
canvas.width = window.innerWidth; canvas.height = window.innerHeight;
const drops = Array(Math.floor(canvas.width/16)).fill(1);
function draw() {
    ctxM.fillStyle = 'rgba(0,0,0,0.05)'; ctxM.fillRect(0,0,canvas.width,canvas.height);
    ctxM.fillStyle = '#0F0';
    drops.forEach((y, i) => {
        ctxM.fillText(Math.floor(Math.random()*2), i*16, y*16);
        if(y*16 > canvas.height && Math.random() > 0.975) drops[i] = 0;
        drops[i]++;
    });
}
setInterval(draw, 50);
</script>
</body>
</html>
